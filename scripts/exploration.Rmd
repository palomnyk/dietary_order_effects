---
title: "Exploratory analysis of ADL metabolomics"
output: "pdf_document"
author: "Aaron Yerke (aaronyerke@gmail.com)"
editor_options: 
  markdown: 
    wrap: 80
---

The purpose of this notebook is to explore the metabolomics from the study
below: BACKGROUND: Crossover studies can induce order effects, especially when
they lack a wash-22 out period.23 OBJECTIVE: We aimed to explore diet order
effects on energy balance and food intake24 between randomized diet order groups
in two inpatient crossover studies originally designed to25 compare within
subject differences in ad libitum energy intake between either minimally26
processed low carbohydrate (LC) versus low fat (LF) diets or macronutrient
matched diets27 composed of mostly minimally processed food (MPF) or
ultra-processed food (UPF).

Starting with the URINE 24h from the

```{r setup}
rm(list = ls()) #clear workspace
knitr::opts_knit$set(root.dir = normalizePath(".."))#Set root
knitr::opts_chunk$set(class.source = "Solarized Light")
```

```{r Load external libraries}
#### Loading libraries and data ####
#read in libraries
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
if (!requireNamespace("ggplot2", quietly = TRUE))  BiocManager::install("ggplot2")
library("ggplot2")
if (!requireNamespace("readxl", quietly = TRUE))  BiocManager::install("readxl")
library("readxl")
if (!requireNamespace("data.table", quietly = TRUE))  BiocManager::install("data.table")
library("data.table")
if(!require(nlme)){install.packages("nlme")}
  library("nlme")
if(!require("lme4")){install.packages("lme4")}
  library("lme4")
if(!require("poolr")){install.packages("poolr")}
  library("poolr")

print("Libraries are loaded.")
```

The metadata contains the processed vs unprocessed info and the order component.

To build our LMM, we need to have a table with only the following columns:
  SUBJECT_ID, ORDER, DIET, TIMEPOINT.

```{r Load and organize metadata}
#### Read metadata ####
# taken from https://app.box.com/file/821046049979
metadata <- openxlsx::read.xlsx(xlsxFile = file.path("data", "NIDDK_linking_LEO_CLEANED_6-11-21.xlsx"),
                                                    sheet = 1)
print(paste("original metadata nrow/ncol:", paste(dim(metadata), collapse = "/")))
metadata <- metadata[metadata$Sample_matrix == "24h Urine",]
metadata <- metadata[metadata$STUDY_NAME == "ADL",]
print(paste("24h urine metadata nrow/ncol:", paste(dim(metadata), collapse = "/")))
metadata <- na.omit(metadata)
print(paste("metadata no NA nrow/ncol:", paste(dim(metadata), collapse = "/")))

row.names(metadata) <- metadata$CLIENT_IDENTIFIER
metadata <- metadata[, c("SUBJECT_ID", "DIET", "DIET_ORDER", "TIMEPOINT")]

metadata$SUBJECT_ID <- as.factor(metadata$SUBJECT_ID)
metadata$DIET <- as.factor(metadata$DIET)
metadata$DIET_ORDER <- as.factor(metadata$DIET_ORDER)
metadata$TIMEPOINT <- ordered(as.factor(metadata$TIMEPOINT))

print(paste("final metad r/c:", paste(dim(metadata), collapse = "/")))
```



This next chunk is a side quest to investigate normalization.

```{r Scaling investigation}
#Taken from https://app.box.com/folder/132711394563
initial_table <- data.table::fread(file = file.path("data", "NIDDK_urine_adl_rslts.csv"),
                                   data.table = FALSE)
print(paste("initial rw/col:", paste(dim(initial_table), collapse = "/")))

#### Reorganize and preprocess table ####
initial_table <- initial_table[initial_table$RSLT_TYPE == "Scaled",]
print(paste("filtered rw/col:", paste(dim(initial_table), collapse = "/")))

#Remove non-metabolomic columns
row.names(initial_table) <- initial_table$CLIENT_IDENTIFIER
initial_table <- initial_table[,7:ncol(initial_table)]
print(paste("rn row rw/col:", paste(dim(initial_table), collapse = "/")))

row_median <- apply(initial_table, 1, median, na.rm=TRUE)
col_median <- apply(initial_table, 2, median, na.rm=TRUE)
df_median <- median(as.matrix(initial_table))

print(median(row_median))
```
It appears that the scaling is so that the median of the row medians is 1.


The metadata starts with 294 rows, but some of those are either full of NA
values or not 24h urine samples. After removing these, there are only 80 rows.

Next read in the metabolomics data.

```{r read and organize metabolomics}
#Load pathway data
urine_metabo_path <- data.table::fread(file = file.path("data", "NIDDK_urine_metabolites.csv"),
                                   data.table = FALSE)
plasma_metabo_path <- data.table::fread(file = file.path("data", "NIDDK_plasma_metabolites.csv"),
                                   data.table = FALSE)

#Taken from https://app.box.com/folder/132711394563
initial_table <- data.frame(data.table::fread(file = file.path("data", "NIDDK_urine_adl_rslts.csv"),
                                   data.table = FALSE))
print(paste("initial rw/col:", paste(dim(initial_table), collapse = "/")))

#### Reorganize and preprocess table ####
initial_table <- initial_table[initial_table$RSLT_TYPE == "Scaled",]
print(paste("scaled rw/col:", paste(dim(initial_table), collapse = "/")))

#Remove non-metabolomic columns
row.names(initial_table) <- initial_table$CLIENT_IDENTIFIER
initial_table <- initial_table[,7:ncol(initial_table)]
print(paste("metabolite only rw/col:", paste(dim(initial_table), collapse = "/")))

#### Remove rows that aren't in metadata
meta_intrsct <- intersect(row.names(initial_table), row.names(metadata))
initial_table <- initial_table[meta_intrsct,]
#order both dataframes the same
my_metadata <- metadata[meta_intrsct,]
print(paste("meta-match rw/col:", paste(dim(initial_table), collapse = "/")))
identical(row.names(my_metadata), row.names(initial_table))

#### Filter metabolites ####
#Remove columns that all but 2 NA
initial_table <- initial_table[,!sapply(initial_table, function(x) length(which(is.na(x))) >= nrow(initial_table)-2)]

#Remove features with more than 80% zeros
# NOTE: Keep NA as NA
na_table <- initial_table
na_table[is.na(na_table)] <- 0
initial_table <- initial_table[,!sapply(na_table, function(x) mean(x == 0) > 0.8)]
print(paste("0 rw/col:", paste(dim(initial_table), collapse = "/")))

# #Exclude metabolites that have a CV>30.0 OR keep metabolites that are < 30
initial_table <- initial_table[,!sapply(initial_table, 
                                       function(x) sd(x, na.rm = T) / mean(x, na.rm = T) < 0.3)]

print(paste("CV rw/col:", paste(dim(initial_table), collapse = "/")))
```


```{r makes scaled imp table}
my_cols <- names(initial_table)

initial_table <- data.frame(data.table::fread(file = file.path("data", "NIDDK_urine_adl_rslts.csv"),
                                   data.table = FALSE))
metabolomics <- initial_table[initial_table$RSLT_TYPE == "Scaled Imp",]
row.names(metabolomics) <- metabolomics$CLIENT_IDENTIFIER
metabolomics <- metabolomics[,7:ncol(metabolomics)]

metabolomics <- metabolomics[meta_intrsct, my_cols]
#log2 table
metabolomics <- log2(metabolomics)

```


Now that they are matching and we have a final table, add the linear mixed model. It should replicate Lauren's SAS:

Proc mixed data=UrineKB1;
class  ARM Treatment SubjectID;
model METABOLITE= ARM Treatment;
random SubjectID;
estimate ‘ARM LC/LF’ intercept 1 Arm 1 0;
estimate ‘ARM LF/LC’ intercept 1 ARM 0 1;
estimate ‘LC/LF vs LF/LC’ ARM 1 -1;
ods output Estimates = tem;
quit;


https://www.r-bloggers.com/2017/12/linear-mixed-effect-models-in-r/
https://mspeekenbrink.github.io/sdam-r-companion/linear-mixed-effects-models.html

``` {r Mixed model}
metaboliteNames <- c()
metadata_col <- c()
pvals <- c()
failed_metabolites <-c()
metabo_levs <- c()
dietorder_pvals <- c()

for (i in 1:ncol(metabolomics)){
  metaboliteName <- colnames(metabolomics)[i]
  myD <- my_metadata
  myD$metabo <- unlist(metabolomics[,i])
  tryCatch(expr = {
          myLme <- nlme::lme( metabo ~ DIET_ORDER + DIET,
          random = ~ TIMEPOINT | SUBJECT_ID,
          data = myD)
          # myLme = nlme::gls(metabo ~  DIET_ORDER*TIMEPOINT + DIET*TIMEPOINT,
          # na.action=na.omit, data=myD,
          # correlation=nlme::corSymm(form= ~ as.integer(TIMEPOINT) | SUBJECT_ID),
          # weights=nlme::varIdent(form=~1|TIMEPOINT))
          },
          error=function(cond) {
            failed_metabolites <<- c(failed_metabolites, metaboliteName)
            print(paste("an error is thrown on iteration", i, metaboliteName))
            message(cond)
            # Choose a return value in case of error
            # return(NA)
          },
          warning=function(cond) {
            failed_metabolites <<- c(failed_metabolites, metaboliteName)
            print(paste("a warning is thrown on iteration", i,metaboliteName))
            message(cond)

            # Choose a return value in case of warning
            # return(NULL)
          }
        )
  #Pull out pvalue for diet_order variable to run through pooled R
  #Look into failed
  myAnova = anova(myLme)
  myPval = myAnova$"p-value"[2]
  metaboliteNames = c(metaboliteNames, metaboliteName)
  pvals =  c(pvals, myPval)
  # metabo_levs <- c(metabo_levs, metabolomics)
  cs <- as.data.frame(summary(myLme)$tTable)
  dietorder_pval <- cs["DIET_ORDER2", "p-value"]
  dietorder_pvals <- c(dietorder_pvals, dietorder_pval)
}

names(dietorder_pvals) <- metaboliteNames
names(pvals) <- metaboliteNames

model1_mean_pval <- mean(pvals)
adj_pvals <- p.adjust(pvals, method = "BH")
model1_mean_adj_pval <- mean(adj_pvals)
sig_metabo <- which(adj_pvals < 0.05)

print(paste("mean global pval for model1:", model1_mean_pval, "\n", sum(pvals < 0.05), "significant out of", length(pvals),"metabolites"))

print(paste("mean global adj_pval for model1:", model1_mean_adj_pval, "\n", sum(adj_pvals < 0.05), "significant out of", length(pvals),"metabolites \n", metaboliteNames[sig_metabo]))



model1_DO_mean_pval <- mean( dietorder_pvals)
DO_adj_pvals <- p.adjust(dietorder_pvals, method = "BH")
model1_DO_mean_adj_pval <- mean(DO_adj_pvals)
DO_sig_metabo <- which(adj_pvals < 0.05)
print(paste("mean DIET_ORDER pval for model1:", model1_DO_mean_pval, "\n", 
            sum(dietorder_pvals < 0.05), "significant out of", 
            length(dietorder_pvals),"metabolites"))

print(paste("mean DIET_ORDER adj_pval for model1:", model1_DO_mean_adj_pval, "\n", sum(DO_adj_pvals < 0.05), "significant out of", length(pvals),"metabolites \n", metaboliteNames[DO_sig_metabo]))

```

Add the pvalue pooling from Erikka's code.

``` {r Combine metabolites based on pathway}
#function to combine pvalues based on pathway using Fisher's method
sup_path_f <- function(result_pv, pathway_col = "SUPER_PATHWAY", 
                       pathway_name, pathway_df, metabolomic_df){
  # Note: result_pv is the result pvals with the metabolites as the names

  # filtering results data set for those in the super pathway of analysis
  pathway_metabos <- pathway_df$SAS_NAME[which(pathway_df[,pathway_col] == pathway_name)]
  
  # filter pvals to only use those that are found in super pathway
  pval_subset <- result_pv[which(names(result_pv) %in% toupper(pathway_metabos))]
  # filter metabolite data
  meta_small <- metabolomic_df[,names(pval_subset)]
  # create correlation matrix
  meta.cor <- cor(meta_small)
  # combine p-values with Fisher's method
  c <- poolr::fisher(pval_subset, adjust = "empirical", R = meta.cor)
  # extracting p-value from result
  z <- c$p
  print(paste(pathway_name, "combined pval:", z))
  return(z)
}


set.seed(5627)
# plasma analysis for super pathway
AA <- sup_path_f(result_pv = pvals, 
           pathway_name = "Amino Acid",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Lipid <- sup_path_f(result_pv = pvals, 
           pathway_name = "Lipid",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Carb <- CoV <- sup_path_f(result_pv = pvals, 
           pathway_name = "Carbohydrate",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
CoV <- sup_path_f(result_pv = pvals, 
           pathway_name = "Cofactors and Vitamins",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Energy <- sup_path_f(result_pv = pvals, 
           pathway_name = "Energy",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Nuc <- sup_path_f(result_pv = pvals, 
           pathway_name = "Nucleotide",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
PCM <- sup_path_f(result_pv = pvals, 
           pathway_name = "Partially Characterized Molecules",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Pep <- sup_path_f(result_pv = pvals, 
           pathway_name = "Peptide",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
# Xeno <- sup_path_f(result_pv = pvals,
#            pathway_name = "Xenobiotics",
#            pathway_df = urine_metabo_path,
#            metabolomic_df = metabolomics)
```
```{r check DIET_ORDER pvals}

AA <- sup_path_f(result_pv = dietorder_pvals,
           pathway_name = "Amino Acid",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Lipid <- sup_path_f(result_pv = dietorder_pvals,
           pathway_name = "Lipid",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Carb <- CoV <- sup_path_f(result_pv = dietorder_pvals, 
           pathway_name = "Carbohydrate",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
CoV <- sup_path_f(result_pv = dietorder_pvals, 
           pathway_name = "Cofactors and Vitamins",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Energy <- sup_path_f(result_pv = dietorder_pvals, 
           pathway_name = "Energy",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Nuc <- sup_path_f(result_pv = dietorder_pvals, 
           pathway_name = "Nucleotide",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
PCM <- sup_path_f(result_pv = dietorder_pvals, 
           pathway_name = "Partially Characterized Molecules",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
Pep <- sup_path_f(result_pv = dietorder_pvals, 
           pathway_name = "Peptide",
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
# Xeno <- sup_path_f(result_pv = dietorder_pvals,
#            pathway_name = "Xenobiotics",
#            pathway_df = urine_metabo_path,
#            metabolomic_df = metabolomics)

```

``` {r side investigation of failed matabolites}

for (metabo in failed_metabolites){
  print(paste(metabo,sum(metabolomics[,metabo] == 0)/nrow(metabolomics)))
}

```


```{r Sub pathway analysis}
sub_pathways <- unique(urine_metabo_path$SUB_PATHWAY)
# output <- ""
sub_pvals <- c()
sub_paths <- c()
for (sub_p in 1:length(sub_pathways)){
  tryCatch({
    pw_nm <- sub_pathways[sub_p]
    my_pv <- sup_path_f(result_pv = pvals,
                        pathway_col = "SUB_PATHWAY",
                        pathway_name = pw_nm,
                        pathway_df = urine_metabo_path,
                        metabolomic_df = metabolomics)
     # output <- paste0(output, pw_nm, ": ", my_pv, "\n")
     sub_pvals <- c(sub_pvals, my_pv)
     sub_paths <- c(sub_paths, pw_nm)
    },
    error=function(cond){
            print(paste("an error is thrown on iteration", sub_p, pw_nm))
            message(cond)
            # Choose a return value in case of error
            # return(NA)
          }
    # warning=function(cond) {
    #   print(paste("a warning is thrown on iteration", sub_p))
    #   message(cond)
    # 
    #   # Choose a return value in case of warning
    #   # return(NULL)
    # }
  )
}
names(sub_pvals) <- sub_paths
model1_mean_pval <- mean(sub_pvals)
sig_metabo <- which(sub_pvals < 0.05)

print(paste("mean global pval for model1:", model1_mean_pval, "\n", sum(sub_pvals < 0.05), "significant out of", length(sub_pvals),"metabolites" ))
print(paste(names(sub_pvals)[sig_metabo], collapse = ", "))

adj_sub_pvals <- p.adjust(sub_pvals, method = "BH")
model1_mean_adj_pval <- mean(adj_sub_pvals)
sig_metabo <- which(adj_sub_pvals < 0.05)

print(paste("mean global adj_pval for model1:", model1_mean_adj_pval, "\n", sum(adj_sub_pvals < 0.05), "significant out of", length(sub_pvals),"metabolites \n", sub_paths[sig_metabo]))

```


```{r Sub pathway analysis DIET_ORDER }
sub_pathways <- unique(urine_metabo_path$SUB_PATHWAY)
output <- ""

for (sub_p in 1:length(sub_pathways)){
           pw_nm <- sub_pathways[sub_p]
           my_pv <- sup_path_f(result_pv = pvals,
           pathway_col = "SUB_PATHWAY",
           pathway_name = pw_nm,
           pathway_df = urine_metabo_path,
           metabolomic_df = metabolomics)
           output <- paste0(output, pw_nm, ": ", my_pv, "\n")

}
```


Model 2

``` {r Mixed model}
metaboliteNames <- c()
metadata_col <- c()
pvals <- c()
failed_metabolites <-c()

for (i in 1:ncol(metabolomics)){
  metaboliteName <- colnames(metabolomics)[i]
  myD <- my_metadata
  myD$metabo <- unlist(metabolomics[,i])
  
  tryCatch(expr = {
          myLme = nlme::lme(metabo ~ DIET_ORDER + TIMEPOINT + DIET*TIMEPOINT + DIET_ORDER*TIMEPOINT,
          method= "REML",
          random = ~ 1 | SUBJECT_ID,
          data = myD)
          },
          error=function(cond) {
            failed_metabolites <- c(failed_metabolites, metaboliteName)
            print(paste("an error is thrown on", metaboliteName))
            message(cond)
            # Choose a return value in case of error
            # return(NA)
          },
          warning=function(cond) {
            print(paste("a warning is thrown on", metaboliteName))
            message(cond)
            # Choose a return value in case of warning
            # return(NULL)
          }
        )
  
  myAnova = anova(myLme)
  myPval = myAnova$"p-value"[2]
  metaboliteNames = c(metaboliteNames, metaboliteName)
  pvals =  c(pvals, myPval)
}

model2_mean_pval <- mean(pvals)
adj_pvals <- p.adjust(pvals, method = "BH")
model2_mean_adj_pval <- mean(adj_pvals)

print(paste("mean pval for model2:", model2_mean_pval, "\n", sum(pvals < 0.05), "significant out of", length(pvals),"metabolites"))

print(paste("mean adj_pval for model2:", model2_mean_adj_pval, "\n", sum(adj_pvals < 0.05), "significant out of", length(pvals),"metabolites"))
```

model 3
``` {r Mixed model}
metaboliteNames <- c()
metadata_col <- c()
pvals <- c()
failed_metabolites <-c()

for (i in 1:2){
  metaboliteName <- colnames(metabolomics)[i]
  myD <- my_metadata
  myD$metabo <- unlist(metabolomics[,i])
  
  tryCatch(expr = {
          myLme = nlme::lme(metabo ~ DIET_ORDER + DIET*DIET_ORDER,
          random= ~1 + SUBJECT_ID + TIMEPOINT,
          data = myD)
          },
          error=function(cond) {
            failed_metabolites <- c(failed_metabolites, metaboliteName)
            print(paste("an error is thrown on", metaboliteName))
            message(cond)
            # Choose a return value in case of error
            # return(NA)
          },
          warning=function(cond) {
            print(paste("a warning is thrown on", metaboliteName))
            message(cond)
            # Choose a return value in case of warning
            # return(NULL)
          }
        )
  
  myAnova = anova(myLme)
  myPval = myAnova$"p-value"[2]
  metaboliteNames = c(metaboliteNames, metaboliteName)
  pvals =  c(pvals, myPval)
}

model3_mean_pval <- mean(pvals)
adj_pvals <- p.adjust(pvals, method = "BH")
model3_mean_adj_pval <- mean(adj_pvals)

print(paste("mean pval for model3:", model3_mean_pval, "\n", sum(pvals < 0.05), "significant out of", length(pvals),"metabolites"))

print(paste("mean adj_pval for model3:", model3_mean_adj_pval, "\n", sum(adj_pvals < 0.05), "significant out of", length(pvals),"metabolites"))
```


Need to visualize model and pvalues
```{r Visualizations}
sig_metabolites <- metaboliteNames[pvals < 0.05]

plot(metabolomics[,sig_metabolites[1]], )

```
